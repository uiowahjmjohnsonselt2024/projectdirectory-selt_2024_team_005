<!-- app/views/grids/show.html.erb -->
<h1 style="text-align: center;"><%= @grid.name %></h1>

<div data-controller="grid" data-grid-size="<%= @visibility %>">
  <div class="grid-container">
    <div id="character-stats">
      <h2>
        <%= @character.character_name %> - Lv <span id="character-level"><%= @character.level %></span>
      </h2>
      <p><strong>HP:</strong> <span id="character-current-hp"><%= @character.current_hp %></span> / <%= @character.max_hp %></p>
      <p><strong>EXP:</strong> <span id="character-current-exp"><%= @character.current_exp %></span> / <span id="character-exp-to-level"><%= @character.exp_to_level %></span></p>
      <p><strong>Shards:</strong> <%= @user.shard_balance %></p>

      <div class="equipped-item">
        <%= image_tag(@weapon.icon, class: 'equipped-item-icon', style: "background-color: #{@weapon.rarity_color};") %>
        <div class="item-details">
          <p class="item-name"><%= @weapon.name %> - Lv <%= @weapon.level %></p>
          <p class="item-stat">ATK: <%= @weapon.atk_bonus %></p>
        </div>
      </div>
      <div class="equipped-item">
        <%= image_tag(@armor.icon, class: 'equipped-item-icon', style: "background-color: #{@armor.rarity_color};") %>
        <div class="item-details">
          <p class="item-name"><%= @armor.name %> - Lv <%= @armor.level %></p>
          <p class="item-stat">DEF: <%= @armor.def_bonus %></p>
        </div>
      </div>

      <h3>Inventory</h3>
      <div class="inventory-grid" data-controller="inventory-grid">
        <% @inventory.items.each_with_index do |item_id, index| %>
          <% item = @inventory.items[index] ? Item.find(@inventory.items[index]) : nil %>
          <div class="inventory-item <%= 'empty-slot' if item.nil? %>"
               style="<%= "background-color:  #{item.rarity_color}" if item %>"
               data-action="
                 click->inventory-grid#select
                 mouseenter->inventory-grid#hover
                 mouseleave->inventory-grid#leave
                 mouseleave->inventory-grid#hidePopoverOnMouseLeave"
               data-index="<%= index %>"
               data-target="inventory-grid.slot">

            <div class="popover-menu" data-target="inventory-grid.popover" style="display: none;">
              <% if item %>
                <div class="popover-buttons">
                  <%= form_with url: use_item_inventory_index_path, method: :post, class: "popover-form", remote: true do %>
                    <%= hidden_field_tag :index, index %>
                    <button type="submit" class="popover-button use-button <%= 'disabled' if @character.level < item.level %>" <%= 'disabled' if @character.level < item.level %>>
                      Use
                    </button>
                  <% end %>
                  <%= form_with url: discard_item_inventory_index_path, method: :post, class: "popover-form", remote: true do %>
                    <%= hidden_field_tag :index, index %>
                    <button type="submit" class="popover-button discard-button">Discard</button>
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="hover-popover" data-target="inventory-grid.hoverPopover" style="display: none;">
              <p style="color: <%= item&.rarity_color %>"><%= item&.rarity_name %></p>
              <p><%= item&.name %> - Lv <%= item&.level %></p>
              <p><%= item&.description %></p>
            </div>

            <% if item %>
              <%= image_tag(item.icon, class: 'inventory-item-icon') %>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if @visibility < Grid::GRID_SIZE %>
        <%= button_to 'Expand (costs 10 shards)', expand_grid_path(@grid), method: :patch, class: 'expand-button' %>
      <% else %>
        <p>Maximum grid size reached.</p>
      <% end %>

    </div>

    <div class="grid" style="grid-template-columns: repeat(<%= @visibility %>, 1fr);">
      <% @grid_matrix.each do |row| %>
        <div class="grid-row">
          <% row.each do |cell| %>
            <% css_class = cell.cell_loc == 'R0C0' ? 'grid-cell safe-zone' : 'grid-cell' %>
            <div class="<%= css_class %>"
                 data-action="click->grid#showDetails"
                 data-cell-id="<%= cell.id %>">
              <%= cell.cell_loc %>
              <% if @character && @character.cell_id == cell.cell_id %>
                <div class="character" data-character-id="<%= @character.id %>" >
                  <%= @character.character_name %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div id="cell-details" data-grid-target="details">
      <h2>Cell Details</h2>
      <div>
        Select a cell to see the details! Use Keyboard to move your character!
      </div>
    </div>
  </div>
</div>